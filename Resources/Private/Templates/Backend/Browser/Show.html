<!DOCTYPE html>
<html lang="en" style="height:100%;width:100%">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>AdmiralCloud Embed</title>
</head>
<body style="height:100%;width:100%">
<div id="images"></div>
<div id="admiral_cloud-browser"
    data-irreObject="{parameters.irreObject}"
    data-typo3-ajax-url="{ajaxUrl}"
    data-iframeurl="{iframeUrl}"
    data-mediaContainerId="{mediaContainerId}"
    data-embedLink="{embedLink}"
     data-iframeHost="{iframeHost}"
     data-modus="{modus}"
>
</div>
<iframe id="elAdmiralCloud" src="" style="width:100%;height:100%"></iframe>
<script>
    var iframeURL_HOST = document.getElementById('admiral_cloud-browser').getAttribute('data-iframeHost');
    var readyCallbacks = [];
    async function loadIframeWithAuthCode(device) {
        const iframe = document.getElementById('elAdmiralCloud');
        //Path to Auth-Helper Node Script
        console.info(iframe.src);
        const resp = await fetch(document.getElementById('admiral_cloud-browser').getAttribute('data-typo3-ajax-url'), {
            method: 'POST',
            headers: {
                Accept: 'application/json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                callbackUrl: document.getElementById('admiral_cloud-browser').getAttribute('data-iframeurl'),
                device,
            }),
        });
        const data = await resp.json();
        console.info(data);
        applyAuthCode(data.code);
    }

    function applyAuthCode(code) {
        const iframe = document.getElementById('elAdmiralCloud');
        iframe.src = document.getElementById('admiral_cloud-browser').getAttribute('data-iframeurl') + '&code=' + code;
    }
    function load(){
        mediaContainerId = document.getElementById('admiral_cloud-browser').getAttribute('data-mediaContainerId');
        embedLink = document.getElementById('admiral_cloud-browser').getAttribute('data-embedLink');
        if (mediaContainerId && embedLink) {
            readyCallbacks.unshift(function () {
                document.getElementById('elAdmiralCloud').contentWindow.postMessage(JSON.stringify({
                    command: 'CROP_IMAGE',
                    mediaContainerId,
                    embedLink
                }), iframeURL_HOST);
            });
        }
        const iframe = document.getElementById('elAdmiralCloud');
        iframe.src = '';
        iframe.src = document.getElementById('admiral_cloud-browser').getAttribute('data-iframeurl') + '&auth=1';
    }

    function executeReadyCallbacks() {
        while (readyCallbacks.length > 0) {
            readyCallbacks.pop().call();
        }
    }

    window.onmessage = function (e) {
        if(e.data) {
            var data = JSON.parse(e.data);
        }

        // Receive Auth Device-Identifier
        if (data.command === 'AUTH') {
            const {device} = data;
            loadIframeWithAuthCode(device);
            return;
        }

        // Receive severe Auth Failure -> Reload
        if (data.command === 'AUTH_FAILURE') {
            console.info('auth_failure');
            return;
        }

        // Receive Signal to execute Ready Callbacks
        if (data.command === 'READY') {
            console.info('ready');
            setTimeout(function () {
                executeReadyCallbacks();
            }, 3000);
            return;
        }

        // Receive Media
        if (data.command === 'MEDIA') {
            console.log('MEDIA', data);
            const isInsertAllowed = true;
            console.log('INSERT?', isInsertAllowed);

            var parentDocument = parent.document,
                contentIframe = parent.document.getElementById('typo3-contentIframe');

            if (contentIframe) {
                parentDocument = contentIframe.contentDocument;
            }

            // Dispatch internal interaction for TYPO3/CMS/AdmiralCloudConnector/Browser
            var modus = document.getElementById('admiral_cloud-browser').getAttribute('data-modus');
            var target = document.getElementById('admiral_cloud-browser').getAttribute('data-irreObject');
            var event, parameters = {
                detail: {
                    target: target,
                    media: data,
                    modus: modus
                }
            };

            if (typeof CustomEvent === 'function') {
                event = new CustomEvent('AdmiralCloudBrowserAddMedia', parameters);
            } else {
                // Add IE11 support
                event = document.createEvent('CustomEvent');
                event.initCustomEvent('AdmiralCloudBrowserAddMedia', true, true, parameters);
            }

            parentDocument.dispatchEvent(event);
        }
    };
    load();

</script>
</body>
</html>
